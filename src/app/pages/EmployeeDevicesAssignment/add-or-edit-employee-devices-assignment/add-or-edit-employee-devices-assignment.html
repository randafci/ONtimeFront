<div class="card">
  <p-stepper [value]="step">
    <p-step-list>
      <p-step [value]="1">Select Employees</p-step>
      <p-step [value]="2">Assign Devices</p-step>
    </p-step-list>
  </p-stepper>

  <!-- Step 1 -->
  <div *ngIf="step === 1" class="mt-4">
    <h3 class="font-semibold text-lg mb-3">Select Employees</h3>
    
    <p-table #employeeTable
             [value]="employees" 
             [(selection)]="selectedEmployees" 
             dataKey="id"
             [rowHover]="true"
             [showGridlines]="true"
             [paginator]="true"
             [rows]="10"
             [globalFilterFields]="['employeeCode', 'firstName', 'lastName', 'employeeType', 'department']">
      
      <!-- Search Template -->
      <ng-template pTemplate="caption">
        <div class="flex justify-between items-center flex-column sm:flex-row">
          <button 
            pButton 
            label="Clear"
            class="p-button-outlined mb-2" 
            icon="pi pi-filter-slash" 
            (click)="clearEmployee(employeeTable)"
          ></button>
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input 
              pInputText 
              type="text" 
             (input)="onGlobalFilter(employeeTable, $event)" 
              placeholder="Search employees..."
            />
          </p-iconfield>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th style="width:3em"></th>
          <th style="min-width: 10rem">
            <div class="flex justify-between items-center">
              Employee Code
              <p-columnFilter type="text" field="employeeCode" display="menu"></p-columnFilter>
            </div>
          </th>
          <th style="min-width: 12rem">
            <div class="flex justify-between items-center">
              Name
              <p-columnFilter type="text" field="firstName" display="menu"></p-columnFilter>
            </div>
          </th>
          <th style="min-width: 12rem">
            <div class="flex justify-between items-center">
              Type
              <p-columnFilter type="text" field="employeeType" display="menu"></p-columnFilter>
            </div>
          </th>
          <th style="min-width: 12rem">
            <div class="flex justify-between items-center">
              Department
              <p-columnFilter type="text" field="department" display="menu"></p-columnFilter>
            </div>
          </th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-emp>
        <tr [pSelectableRow]="emp">
          <td><p-tableCheckbox [value]="emp"></p-tableCheckbox></td>
          <td>{{emp.employeeCode}}</td>
          <td>{{ getFullName(emp) }}</td>
          <td>{{ emp.employeeType || 'N/A' }}</td>
          <td>{{ emp.department || 'N/A' }}</td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td [attr.colspan]="5" class="text-center">
            {{ employeeSearchValue ? 'No employees found matching your search.' : 'No employees available.' }}
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="loadingbody">
        <tr>
          <td [attr.colspan]="5" class="text-center">
            Loading employees...
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="flex justify-end mt-4">
      <button pButton label="Next" icon="pi pi-arrow-right" (click)="nextStep()" [disabled]="!selectedEmployees.length"></button>
    </div>
  </div>

  <!-- Step 2 -->
   <div *ngIf="step === 2" class="mt-4">
    <h3 class="font-semibold text-lg mb-3">Assign Devices</h3>

    <div class="card mt-4">
      <div class="flex flex-col md:flex-row">
        <!-- Left Panel: Location Filter -->
       <div class="w-full md:w-5/12 flex flex-col justify-center py-5">
        <p-table #locationTable
                 [value]="locations" 
                 [(selection)]="selectedLocations" 
                 dataKey="id"
                 [rowHover]="true"
                 [showGridlines]="true"
                 [paginator]="true"
                 [rows]="10"
                 [globalFilterFields]="['name']">

          <!-- Search Template -->
          <ng-template pTemplate="caption">
            <div class="flex justify-between items-center flex-column sm:flex-row">
              <button 
                pButton 
                label="Clear"
                class="p-button-outlined mb-2" 
                icon="pi pi-filter-slash" 
                (click)="clearEmployee(locationTable)"
              ></button>
              <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon>
                  <i class="pi pi-search"></i>
                </p-inputicon>
                <input 
                  pInputText 
                  type="text" 
                  [(ngModel)]="locationSearchValue"
                  (input)="onGlobalFilter(locationTable, $event)" 
                  placeholder="Search locations..."
                />
              </p-iconfield>
            </div>
          </ng-template>

          <ng-template pTemplate="header">
            <tr>
              <th style="width:3em"></th>
              <th style="min-width: 12rem">
                <div class="flex justify-between items-center">
                  Location Name
                  <p-columnFilter type="text" field="name" display="menu"></p-columnFilter>
                </div>
              </th>
            </tr>
          </ng-template>
          
          <ng-template pTemplate="body" let-loc>
            <tr [pSelectableRow]="loc">
              <td><p-tableCheckbox [value]="loc"></p-tableCheckbox></td>
              <td>{{ loc.name }}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td [attr.colspan]="2" class="text-center">
                {{ locationSearchValue ? 'No locations found matching your search.' : 'No locations available.' }}
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="loadingbody">
            <tr>
              <td [attr.colspan]="2" class="text-center">
                Loading locations...
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

        <!-- Divider -->
        <div class="w-full md:w-2/12">
          <p-divider layout="vertical" class="hidden! md:flex!"><b>AND</b></p-divider>
          <p-divider layout="horizontal" class="flex! md:hidden!" align="center"><b>AND</b></p-divider>
        </div>

        <!-- Right Panel: Device Table -->
        <div class="w-full md:w-7/12 flex flex-col justify-center py-5">
          <p-table #table
                   [value]="devices" 
                   [(selection)]="selectedDevices" 
                   dataKey="id"
                   [lazy]="true"
                   [loading]="loading"
                   [totalRecords]="totalRecords"
                   (onLazyLoad)="loadDevicesLazy($event)"
                   [rows]="rows"
                   [paginator]="true"
                   [rowsPerPageOptions]="[5, 10, 20, 50]">
            
            <!-- Search Template -->
            <ng-template pTemplate="caption">
      <div class="flex justify-between items-center flex-column sm:flex-row">
                <button
                  pButton
                  pRipple
                  (click)="clear(table)"
                  icon="pi pi-filter-slash"
                  class="p-button-outlined"
                  label="Clear">
                </button>
                 <p-iconfield iconPosition="left" class="ml-auto">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input 
            pInputText 
            type="text" 
            #filter
             [(ngModel)]="searchValue"
            (input)="onSearch(table)"
            [placeholder]="'locationList.searchPlaceholder' " 
          />
        </p-iconfield>
              
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th style="width: 3rem">
                  <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th *ngFor="let col of cols" [pSortableColumn]="col.field">
                  {{col.header}}
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-dev>
              <tr>
                <td>
                  <p-tableCheckbox [value]="dev"></p-tableCheckbox>
                </td>
                <td>{{dev.code}}</td>
                <td>{{dev.name}}</td>
                <td>{{dev.location}}</td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td [attr.colspan]="cols.length + 1" class="text-center">
                  {{ searchValue || selectedLocation ? 'No devices found matching your criteria.' : 'No devices available.' }}
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="loadingbody">
              <tr>
                <td [attr.colspan]="cols.length + 1" class="text-center">
                  Loading devices...
                </td>
              </tr>
            </ng-template>
          </p-table>

          <!-- Status messages -->
          <p *ngIf="selectedLocation && devices.length === 0 && !loading" class="text-center text-red-500 mt-4">
            No devices found for this location.
          </p>
          <p *ngIf="!selectedLocation && !searchValue" class="text-center text-gray-500 mt-4">
            Please enter a location or search term to find devices.
          </p>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="flex justify-between mt-6">
        <button pButton label="Back" icon="pi pi-arrow-left" class="p-button-secondary" (click)="prevStep()"></button>
        <button pButton label="Submit" icon="pi pi-check" (click)="submit()" [disabled]="!selectedDevices.length"></button>
      </div>
    </div>
  </div>
</div>





