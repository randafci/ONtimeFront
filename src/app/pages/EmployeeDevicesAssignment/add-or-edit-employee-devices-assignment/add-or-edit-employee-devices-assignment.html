<div class="card">
  <p-stepper [value]="step">
    <p-step-list>
      <p-step [value]="1">{{ 'employeeDevicesAssignment.step1.title' | translate }}</p-step>
      <p-step [value]="2">{{ 'employeeDevicesAssignment.step2.title' | translate }}</p-step>
    </p-step-list>
  </p-stepper>

  <!-- Step 1 -->
  <div *ngIf="step === 1" class="mt-4">
    <h3 class="font-semibold text-lg mb-3">{{ 'employeeDevicesAssignment.step1.title' | translate }}</h3>
    
    <p-table #employeeTable [value]="employees" [(selection)]="selectedEmployees" dataKey="id"
             [rowHover]="true" [showGridlines]="true" [paginator]="true" [rows]="10"
             [globalFilterFields]="['employeeCode', 'firstName', 'lastName', 'employeeType', 'department']">
      
      <ng-template pTemplate="caption">
        <div class="flex justify-between items-center">
          <button pButton [label]="'common.buttons.clear' | translate" class="p-button-outlined" 
                  icon="pi pi-filter-slash" (click)="clearEmployee(employeeTable)"></button>
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon><i class="pi pi-search"></i></p-inputicon>
            <input pInputText type="text" (input)="onGlobalFilter(employeeTable, $event)" 
                   [placeholder]="'employeeDevicesAssignment.step1.searchPlaceholder' | translate"/>
          </p-iconfield>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr>
          <th style="width:3em"></th>
          <th>{{ 'employeeDevicesAssignment.step1.headers.employeeCode' | translate }}</th>
          <th>{{ 'employeeDevicesAssignment.step1.headers.name' | translate }}</th>
          <th>{{ 'employeeDevicesAssignment.step1.headers.type' | translate }}</th>
          <th>{{ 'employeeDevicesAssignment.step1.headers.department' | translate }}</th>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="body" let-emp>
        <tr [pSelectableRow]="emp">
          <td><p-tableCheckbox [value]="emp"></p-tableCheckbox></td>
          <td>{{emp.employeeCode}}</td>
          <td>{{ getFullName(emp) }}</td>
          <td>{{ emp.employeeType || 'N/A' }}</td>
          <td>{{ emp.department || 'N/A' }}</td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">
            {{ (employeeSearchValue ? 'employeeDevicesAssignment.step1.messages.emptySearch' : 'employeeDevicesAssignment.step1.messages.emptyDefault') | translate }}
          </td>
        </tr>
      </ng-template>
      
      <ng-template pTemplate="loadingbody">
        <tr><td colspan="5" class="text-center">{{ 'employeeDevicesAssignment.step1.messages.loading' | translate }}</td></tr>
      </ng-template>
    </p-table>

    <div class="flex justify-end mt-4">
      <button pButton [label]="'employeeDevicesAssignment.step1.buttons.next' | translate" icon="pi pi-arrow-right" 
              (click)="nextStep()" [disabled]="!selectedEmployees.length"></button>
    </div>
  </div>

  <!-- Step 2 -->
   <div *ngIf="step === 2" class="mt-4">
    <h3 class="font-semibold text-lg mb-3">{{ 'employeeDevicesAssignment.step2.title' | translate }}</h3>

    <div class="card mt-4">
      <div class="flex flex-col md:flex-row">
        <!-- Left Panel: Location Filter -->
       <div class="w-full md:w-5/12 flex flex-col justify-center py-5">
        <p-table #locationTable [value]="locations" [(selection)]="selectedLocations" dataKey="id"
                 [rowHover]="true" [showGridlines]="true" [paginator]="true" [rows]="10"
                 [globalFilterFields]="['name']">

          <ng-template pTemplate="caption">
            <div class="flex justify-between items-center">
              <button pButton [label]="'common.buttons.clear' | translate" class="p-button-outlined" 
                      icon="pi pi-filter-slash" (click)="clearEmployee(locationTable)"></button>
              <p-iconfield iconPosition="left" class="ml-auto">
                <p-inputicon><i class="pi pi-search"></i></p-inputicon>
                <input pInputText type="text" [(ngModel)]="locationSearchValue"
                       (input)="onGlobalFilter(locationTable, $event)" 
                       [placeholder]="'employeeDevicesAssignment.step2.locations.searchPlaceholder' | translate"/>
              </p-iconfield>
            </div>
          </ng-template>

          <ng-template pTemplate="header">
            <tr>
              <th style="width:3em"></th>
              <th>{{ 'employeeDevicesAssignment.step2.locations.header' | translate }}</th>
            </tr>
          </ng-template>
          
          <ng-template pTemplate="body" let-loc>
            <tr [pSelectableRow]="loc">
              <td><p-tableCheckbox [value]="loc"></p-tableCheckbox></td>
              <td>{{ loc.name }}</td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="2" class="text-center">
                {{ (locationSearchValue ? 'employeeDevicesAssignment.step2.locations.messages.emptySearch' : 'employeeDevicesAssignment.step2.locations.messages.emptyDefault') | translate }}
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="loadingbody">
            <tr><td colspan="2" class="text-center">{{ 'employeeDevicesAssignment.step2.locations.messages.loading' | translate }}</td></tr>
          </ng-template>
        </p-table>
      </div>

        <!-- Divider -->
        <div class="w-full md:w-2/12">
          <p-divider layout="vertical" class="hidden! md:flex!"><b>{{ 'common.and' | translate | uppercase }}</b></p-divider>
          <p-divider layout="horizontal" class="flex! md:hidden!" align="center"><b>{{ 'common.and' | translate | uppercase }}</b></p-divider>
        </div>

        <!-- Right Panel: Device Table -->
        <div class="w-full md:w-7/12 flex flex-col justify-center py-5">
          <p-table #table [value]="devices" [(selection)]="selectedDevices" dataKey="id" [lazy]="true"
                   [loading]="loading" [totalRecords]="totalRecords" (onLazyLoad)="loadDevicesLazy($event)"
                   [rows]="rows" [paginator]="true" [rowsPerPageOptions]="[5, 10, 20, 50]">
            
            <ng-template pTemplate="caption">
              <div class="flex justify-between items-center">
                <button pButton pRipple (click)="clear(table)" icon="pi pi-filter-slash" class="p-button-outlined" 
                        [label]="'common.buttons.clear' | translate"></button>
                 <p-iconfield iconPosition="left" class="ml-auto">
                  <p-inputicon><i class="pi pi-search"></i></p-inputicon>
                  <input pInputText type="text" #filter [(ngModel)]="searchValue" (input)="onSearch(table)"
                         [placeholder]="'employeeDevicesAssignment.step2.devices.searchPlaceholder' | translate" />
                 </p-iconfield>
              </div>
            </ng-template>

            <ng-template pTemplate="header">
              <tr>
                <th style="width: 3rem"><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
                <th>{{ 'employeeDevicesAssignment.step2.devices.headers.code' | translate }}</th>
                <th>{{ 'employeeDevicesAssignment.step2.devices.headers.name' | translate }}</th>
                <th>{{ 'employeeDevicesAssignment.step2.devices.headers.location' | translate }}</th>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="body" let-dev>
              <tr>
                <td><p-tableCheckbox [value]="dev"></p-tableCheckbox></td>
                <td>{{dev.code}}</td>
                <td>{{dev.name}}</td>
                <td>{{dev.location}}</td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="4" class="text-center">
                  {{ (searchValue || selectedLocation ? 'employeeDevicesAssignment.step2.devices.messages.emptyCriteria' : 'employeeDevicesAssignment.step2.devices.messages.emptyDefault') | translate }}
                </td>
              </tr>
            </ng-template>
            
            <ng-template pTemplate="loadingbody">
              <tr><td colspan="4" class="text-center">{{ 'employeeDevicesAssignment.step2.devices.messages.loading' | translate }}</td></tr>
            </ng-template>
          </p-table>

          <p *ngIf="selectedLocation && devices.length === 0 && !loading" class="text-center text-red-500 mt-4">
            {{ 'employeeDevicesAssignment.step2.devices.messages.noDevicesForLocation' | translate }}
          </p>
          <p *ngIf="!selectedLocation && !searchValue" class="text-center text-gray-500 mt-4">
            {{ 'employeeDevicesAssignment.step2.devices.messages.selectLocationPrompt' | translate }}
          </p>
        </div>
      </div>

      <div class="flex justify-between mt-6">
        <button pButton [label]="'employeeDevicesAssignment.step2.buttons.back' | translate" icon="pi pi-arrow-left" 
                class="p-button-secondary" (click)="prevStep()"></button>
        <button pButton [label]="'employeeDevicesAssignment.step2.buttons.submit' | translate" icon="pi pi-check" 
                (click)="submit()" [disabled]="!selectedDevices.length"></button>
      </div>
    </div>
  </div>
</div>