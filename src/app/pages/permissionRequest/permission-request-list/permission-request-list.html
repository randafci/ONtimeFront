<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="card">
  <div class="flex justify-between items-center mb-4">
    <h1 class="font-semibold text-xl mb-0">
      Permission Requests
    </h1>
    <div class="flex-grow-1"></div>
    <button
      pButton
      label="New Request"
      icon="pi pi-plus"
      class="p-button-sm"
      (click)="openCreateDialog()"
    ></button>
  </div>

  <p-table
    #dt
    [value]="requests"
    dataKey="id"
    [rows]="10"
    [loading]="loading"
    [paginator]="true"
    [rowHover]="true"
    [showGridlines]="true"
    responsiveLayout="scroll"
    [globalFilterFields]="['employeeName', 'permissionRequestType', 'status']"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    [showCurrentPageReport]="true"
  >
    <ng-template pTemplate="caption">
      <div class="flex justify-between items-center flex-column sm:flex-row">
        <button
          pButton
          label="Clear"
          class="p-button-outlined mb-2"
          icon="pi pi-filter-slash"
          (click)="clear(dt)"
        ></button>
        <p-iconfield iconPosition="left" class="ml-auto">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input
            pInputText
            type="text"
            #filter
            (input)="onGlobalFilter(dt, $event)"
            placeholder="Search..."
          />
        </p-iconfield>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th style="min-width: 6rem">
          <div class="flex justify-between items-center">
            ID
            <p-columnFilter type="text" field="id" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          <div class="flex justify-between items-center">
            Employee
            <p-columnFilter type="text" field="employeeName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 10rem">
          <div class="flex justify-between items-center">
            Type
            <p-columnFilter type="text" field="permissionRequestType" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 10rem">
          <div class="flex justify-between items-center">
            From Date
            <p-columnFilter type="date" field="fromDate" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 10rem">
          <div class="flex justify-between items-center">
            To Date
            <p-columnFilter type="date" field="toDate" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 10rem">
          <div class="flex justify-between items-center">
            Status
            <p-columnFilter field="status" matchMode="equals" display="menu">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-select
                  [ngModel]="value"
                  [options]="statusOptions"
                  (onChange)="filter($event.value)"
                  placeholder="Any"
                  [style]="{ 'min-width': '12rem' }"
                >
                  <ng-template let-option pTemplate="item">
                    <p-tag
                      [value]="option.label"
                      [severity]="getSeverity(option.value)"
                    ></p-tag>
                  </ng-template>
                </p-select>
              </ng-template>
            </p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          <div class="flex justify-between items-center">
            Workflow
            <p-columnFilter type="text" field="workflowName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 8rem">
          Actions
        </th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
      <tr>
        <td>{{ item.id }}</td>
        <td>{{ item.employeeName }}</td>
        <td>{{ item.permissionRequestType }}</td>
        <td>{{ item.fromDate | date: 'mediumDate' }}</td>
        <td>{{ item.toDate | date: 'mediumDate' }}</td>
        <td>
          <p-tag 
            [value]="getStatusName(item.status)"
            [severity]="getSeverity(item.status)"
          ></p-tag>
        </td>
        <td>{{ item.workflowName }}</td>
        <td>
          <button
            pButton
            icon="pi pi-pencil"
            class="p-button-rounded p-button-text p-button-sm"
            (click)="openEditDialog(item)"
          ></button>
          <button
            pButton
            icon="pi pi-trash"
            class="p-button-rounded p-button-text p-button-danger p-button-sm"
            (click)="delete(item)"
          ></button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8">No permission requests found.</td>
      </tr>
    </ng-template>

    <ng-template pTemplate="loadingbody">
      <tr>
        <td colspan="8">Loading permission requests...</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Create/Edit Dialog -->
<p-dialog 
  [(visible)]="dialogVisible" 
  [header]="isEditMode ? 'Edit Permission Request' : 'Create Permission Request'"
  [modal]="true" 
  [style]="{width: '50vw'}"
  [draggable]="false" 
  [resizable]="false"
>
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      
      <!-- Employee -->
      <div class="field">
        <label for="employeeEmploymentId" class="block text-sm font-medium mb-2">
          Employee <span class="text-red-500">*</span>
        </label>
        <p-select
          id="employeeEmploymentId"
          [options]="employees"
          optionLabel="firstName"
          optionValue="id"
          formControlName="employeeEmploymentId"
          placeholder="Select Employee"
          class="w-full"
          [class.ng-invalid]="form.get('employeeEmploymentId')?.invalid && form.get('employeeEmploymentId')?.touched"
        ></p-select>
        <small class="text-red-500" *ngIf="form.get('employeeEmploymentId')?.invalid && form.get('employeeEmploymentId')?.touched">
          Employee is required
        </small>
      </div>

      <!-- Permission Type -->
      <div class="field">
        <label for="permissionTypeId" class="block text-sm font-medium mb-2">
          Permission Type <span class="text-red-500">*</span>
        </label>
        <p-select
          id="permissionTypeId"
          [options]="permissionTypes"
          optionLabel="name"
          optionValue="id"
          formControlName="permissionTypeId"
          placeholder="Select Type"
          class="w-full"
          [class.ng-invalid]="form.get('permissionTypeId')?.invalid && form.get('permissionTypeId')?.touched"
        ></p-select>
        <small class="text-red-500" *ngIf="form.get('permissionTypeId')?.invalid && form.get('permissionTypeId')?.touched">
          Permission type is required
        </small>
      </div>

      <!-- From Date -->
      <div class="field">
        <label for="fromDate" class="block text-sm font-medium mb-2">
          From Date <span class="text-red-500">*</span>
        </label>
        <input 
          pInputText 
          type="date" 
          id="fromDate" 
          formControlName="fromDate" 
          class="w-full"
          [class.ng-invalid]="form.get('fromDate')?.invalid && form.get('fromDate')?.touched"
        />
        <small class="text-red-500" *ngIf="form.get('fromDate')?.invalid && form.get('fromDate')?.touched">
          From date is required
        </small>
      </div>

      <!-- To Date -->
      <div class="field">
        <label for="toDate" class="block text-sm font-medium mb-2">
          To Date <span class="text-red-500">*</span>
        </label>
        <input 
          pInputText 
          type="date" 
          id="toDate" 
          formControlName="toDate" 
          class="w-full"
          [class.ng-invalid]="form.get('toDate')?.invalid && form.get('toDate')?.touched"
        />
        <small class="text-red-500" *ngIf="form.get('toDate')?.invalid && form.get('toDate')?.touched">
          To date is required
        </small>
      </div>
<!-- From Time -->
<div class="field">
  <label for="fromTime" class="block text-sm font-medium mb-2">
    From Time
  </label>
  <input 
    pInputText 
    type="time" 
    id="fromTime" 
    formControlName="fromTime" 
    class="w-full"
  />
</div>

<!-- To Time -->
<div class="field">
  <label for="toTime" class="block text-sm font-medium mb-2">
    To Time
  </label>
  <input 
    pInputText 
    type="time" 
    id="toTime" 
    formControlName="toTime" 
    class="w-full"
  />
</div>

      <!-- Workflow -->
      <div class="field">
        <label for="workflowId" class="block text-sm font-medium mb-2">
          Workflow
        </label>
        <p-select
          id="workflowId"
          [options]="workflows"
          optionLabel="workflowName"
          optionValue="id"
          formControlName="workflowId"
          placeholder="Select Workflow"
          class="w-full"
        ></p-select>
      </div>

      <!-- Status -->
      <div class="field">
        <label for="status" class="block text-sm font-medium mb-2">
          Status
        </label>
        <p-select
          id="status"
          [options]="statusOptions"
          optionLabel="name"
          optionValue="id"
          formControlName="status"
          class="w-full bg-gray-100"
          [readonly]="true"
        ></p-select>
      </div>

      <!-- Comments -->
      <div class="field md:col-span-2">
        <label for="comments" class="block text-sm font-medium mb-2">
          Comments
        </label>
        <textarea 
          pInputTextarea 
          id="comments" 
          formControlName="comments" 
          rows="3"
          class="w-full"
        ></textarea>
      </div>
      <!-- Attachment -->
<div class="field md:col-span-2">
  <label for="attachmentURL" class="block text-sm font-medium mb-2">
    Attachment
  </label>

  <!-- File input -->
  <input 
    type="file" 
    id="attachmentURL" 
    (change)="onFileSelected($event)" 
    accept=".jpg,.jpeg,.png,.pdf"
    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
  />

  <!-- File preview -->
  <div *ngIf="filePreviewUrl" class="mt-3">
    <div *ngIf="isImage(filePreviewUrl)" class="flex justify-center">
      <img [src]="filePreviewUrl" alt="Preview" class="max-h-40 rounded-lg border" />
    </div>
    <div *ngIf="!isImage(filePreviewUrl)" class="flex items-center gap-2 text-blue-600">
      <i class="pi pi-file-pdf text-red-500"></i>
      <a [href]="filePreviewUrl" target="_blank" class="underline">View PDF</a>
    </div>
  </div>

  <!-- Upload progress -->
  <small *ngIf="uploading" class="text-gray-500">Uploading...</small>
</div>


    </div>

    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
      <button 
        pButton 
        label="Cancel" 
        class="p-button-secondary" 
        type="button"
        (click)="closeDialog()">
      </button>
      <button 
        pButton 
        [label]="isEditMode ? 'Update' : 'Save'" 
        [loading]="loading"
        type="submit">
      </button>
    </div>
  </form>
</p-dialog>
