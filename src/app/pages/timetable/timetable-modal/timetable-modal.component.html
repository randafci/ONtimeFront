<!-- Create/Edit TimeTable Dialog -->
<p-dialog 
  [(visible)]="dialogVisible" 
  [header]="(isEditMode ? 'timetable.modal.title.edit' : 'timetable.modal.title.add') | translate"
  [modal]="true" 
  [style]="{width: '80vw', maxWidth: '1000px'}"
  [draggable]="false" 
  [resizable]="false"
  (onHide)="onDialogHide()">
  <form [formGroup]="timeTableForm" (ngSubmit)="onSubmit()">
    <!-- Basic Information -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <h3 class="col-span-full text-lg font-semibold border-b pb-2 mb-4">{{ 'timetable.modal.sections.basicInfo' | translate }}</h3>
      
      <!-- Name (English) -->
      <div class="field">
        <label for="nameEn" class="block text-sm font-medium mb-2">
          {{ 'timetable.modal.labels.nameEn' | translate }} <span class="text-red-500">*</span>
        </label>
        <input 
          id="nameEn" 
          type="text" 
          pInputText 
          class="w-full"
          formControlName="nameEn" 
          [placeholder]="'timetable.modal.placeholders.nameEn' | translate"
          [class.ng-invalid]="timeTableForm.get('nameEn')?.invalid && timeTableForm.get('nameEn')?.touched"
        />
        <small class="text-red-500" *ngIf="timeTableForm.get('nameEn')?.invalid && timeTableForm.get('nameEn')?.touched">
          {{ 'timetable.modal.validation.nameEnRequired' | translate }}
        </small>
      </div>

      <!-- Name (Arabic) -->
      <div class="field">
        <label for="nameAr" class="block text-sm font-medium mb-2">
          {{ 'timetable.modal.labels.nameAr' | translate }}
        </label>
        <input 
          id="nameAr" 
          type="text" 
          pInputText 
          class="w-full"
          formControlName="nameAr" 
          [placeholder]="'timetable.modal.placeholders.nameAr' | translate"
        />
      </div>

      <!-- Organization -->
      <div class="field" [ngClass]="{'md:col-span-2': !isSuperAdmin}">
        <label for="organizationId" class="block text-sm font-medium mb-2">
          {{ 'timetable.modal.labels.organization' | translate }} <span class="text-red-500">*</span>
          <span *ngIf="!isSuperAdmin" class="text-xs text-gray-500 ml-1">({{ 'timetable.modal.hints.autoSelectedOrg' | translate }})</span>
        </label>
        <p-select
          id="organizationId"
          formControlName="organizationId"
          [options]="organizationOptions"
          optionLabel="label"
          optionValue="value"
          [placeholder]="'timetable.modal.placeholders.selectOrganization' | translate"
          [disabled]="!isSuperAdmin"
          class="w-full"
          appendTo="body"
          [class.ng-invalid]="timeTableForm.get('organizationId')?.invalid && timeTableForm.get('organizationId')?.touched"
        />
        <small class="text-red-500" *ngIf="timeTableForm.get('organizationId')?.invalid && timeTableForm.get('organizationId')?.touched">
          {{ 'timetable.modal.validation.organizationRequired' | translate }}
        </small>
        <small class="text-gray-500" *ngIf="!isSuperAdmin">
          {{ 'timetable.modal.hints.assignedOrgOnly' | translate }}
        </small>
      </div>

      <!-- Status -->
      <div class="field flex items-center" *ngIf="isSuperAdmin">
        <p-checkbox 
          id="isActive"
          formControlName="isActive"
          [binary]="true"
        />
        <label for="isActive" class="ml-2 text-sm">{{ 'timetable.modal.labels.active' | translate }}</label>
      </div>
    </div>

    <!-- Time Configuration -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
      <h3 class="col-span-full text-lg font-semibold border-b pb-2 mb-4">{{ 'timetable.modal.sections.timeConfig' | translate }}</h3>
      
      <!-- Start Time -->
      <div class="field">
        <label for="startTime" class="block text-sm font-medium mb-2">
          {{ 'timetable.modal.labels.startTime' | translate }} <span class="text-red-500">*</span>
        </label>
        <input 
          id="startTime" 
          type="time" 
          pInputText 
          class="w-full"
          formControlName="startTime"
          (change)="timeTableForm.updateValueAndValidity()"
          [class.ng-invalid]="timeTableForm.get('startTime')?.invalid && timeTableForm.get('startTime')?.touched"
        />
        <small class="text-red-500" *ngIf="timeTableForm.get('startTime')?.invalid && timeTableForm.get('startTime')?.touched">
          {{ 'timetable.modal.validation.startTimeRequired' | translate }}
        </small>
      </div>

      <!-- End Time -->
      <div class="field">
        <label for="endTime" class="block text-sm font-medium mb-2">
          {{ 'timetable.modal.labels.endTime' | translate }} <span class="text-red-500">*</span>
        </label>
        <input 
          id="endTime" 
          type="time" 
          pInputText 
          class="w-full"
          formControlName="endTime"
          (change)="timeTableForm.updateValueAndValidity()"
          [class.ng-invalid]="timeTableForm.get('endTime')?.invalid && timeTableForm.get('endTime')?.touched"
        />
        <small class="text-red-500" *ngIf="timeTableForm.get('endTime')?.invalid && timeTableForm.get('endTime')?.touched">
          {{ 'timetable.modal.validation.endTimeRequired' | translate }}
        </small>
      </div>

      <!-- Time Validation Error Message -->
      <div class="field md:col-span-2" *ngIf="getTimeValidationError()">
        <div class="bg-red-50 border border-red-200 rounded-md p-3">
          <div class="flex items-center">
            <i class="pi pi-exclamation-triangle text-red-500 mr-2"></i>
            <small class="text-red-600 font-medium">{{ getTimeValidationError() }}</small>
          </div>
        </div>
      </div>

      <!-- Working Hours Display -->
      <div class="field md:col-span-2" *ngIf="getWorkingHours()">
        <div class="bg-green-50 border border-green-200 rounded-md p-3">
          <div class="flex items-center">
            <i class="pi pi-clock text-green-600 mr-2"></i>
            <small class="text-green-700 font-medium">
              Working Hours: {{ getWorkingHours() }}
              <span *ngIf="timeTableForm.get('isNightShift')?.value" class="ml-2 text-xs">(Night shift spans midnight)</span>
              <span *ngIf="timeTableForm.get('isPreNightShift')?.value" class="ml-2 text-xs">(Pre-Night shift)</span>
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Shift Configuration -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
      <h3 class="col-span-full text-lg font-semibold border-b pb-2 mb-4">{{ 'timetable.modal.sections.shiftConfig' | translate }}</h3>
      
      <!-- Shift Rules Info -->
      <div class="field md:col-span-2">
        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <div class="flex items-start">
            <i class="pi pi-info-circle text-blue-500 mr-2 mt-0.5"></i>
            <div class="text-sm text-blue-700">
              <strong>Shift Time Rules:</strong><br>
              • <strong>Regular Shift:</strong> End time must be later than start time (e.g., 09:00 - 17:00)<br>
              • <strong>Night Shift:</strong> Full night shift - end time must be earlier than start time, spans midnight (e.g., 22:00 - 06:00)<br>
              • <strong>Pre-Night Shift:</strong> Partial night shift - starts during night hours (e.g., 01:00 - 07:00)<br>
              • <strong>Note:</strong> Night Shift and Pre-Night Shift are mutually exclusive - only one can be selected
            </div>
          </div>
        </div>
      </div>
      
      <!-- Night Shift -->
      <div class="field flex items-center">
        <p-checkbox 
          id="isNightShift"
          formControlName="isNightShift"
          [binary]="true"
          (onChange)="onShiftTypeChange('night')"
        />
        <label for="isNightShift" class="ml-2 text-sm">{{ 'timetable.modal.labels.nightShift' | translate }}</label>
      </div>

      <!-- Pre-Night Shift -->
      <div class="field flex items-center">
        <p-checkbox 
          id="isPreNightShift"
          formControlName="isPreNightShift"
          [binary]="true"
          (onChange)="onShiftTypeChange('preNight')"
        />
        <label for="isPreNightShift" class="ml-2 text-sm">{{ 'timetable.modal.labels.preNightShift' | translate }}</label>
      </div>

      <!-- Weekend -->
      <div class="field flex items-center">
        <p-checkbox 
          id="isWeekend"
          formControlName="isWeekend"
          [binary]="true"
        />
        <label for="isWeekend" class="ml-2 text-sm">{{ 'timetable.modal.labels.weekend' | translate }}</label>
      </div>

      <!-- Open Shift -->
      <div class="field flex items-center">
        <p-checkbox 
          id="isOpenShift"
          formControlName="isOpenShift"
          [binary]="true"
        />
        <label for="isOpenShift" class="ml-2 text-sm">{{ 'timetable.modal.labels.openShift' | translate }}</label>
      </div>

      <!-- Training Course -->
      <div class="field flex items-center">
        <p-checkbox 
          id="isTrainingCourse"
          formControlName="isTrainingCourse"
          [binary]="true"
        />
        <label for="isTrainingCourse" class="ml-2 text-sm">{{ 'timetable.modal.labels.trainingCourse' | translate }}</label>
      </div>

      <!-- Extra Training Hours -->
      <div class="field" *ngIf="timeTableForm.get('isTrainingCourse')?.value">
        <label for="trainingCourseExtraWorkHours" class="block text-sm font-medium mb-2">
          Extra Training Hours
        </label>
        <p-inputNumber
          id="trainingCourseExtraWorkHours"
          formControlName="trainingCourseExtraWorkHours"
          [min]="0"
          [max]="24"
          suffix=" hours"
          placeholder="0"
          class="w-full"
        />
      </div>
    </div>

    <!-- Flexible Range -->
    <div class="grid grid-cols-1 gap-4 mt-6">
      <h3 class="text-lg font-semibold border-b pb-2 mb-4">{{ 'timetable.modal.sections.flexibleRange' | translate }}</h3>
      
      <div class="field flex items-center mb-4">
        <p-checkbox 
          id="isCheckInOutRangeEnabled"
          formControlName="isCheckInOutRangeEnabled"
          [binary]="true"
          (onChange)="onFlexibleRangeChange()"
        />
        <label for="isCheckInOutRangeEnabled" class="ml-2 text-sm">{{ 'timetable.modal.labels.enableFlexibleRange' | translate }}</label>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4" *ngIf="timeTableForm.get('isCheckInOutRangeEnabled')?.value">
        <!-- Earliest Check-in -->
        <div class="field">
          <label for="beginIn" class="block text-sm font-medium mb-2">
            Earliest Check-in
          </label>
          <input 
            id="beginIn" 
            type="time" 
            pInputText 
            class="w-full"
            formControlName="beginIn"
          />
        </div>

        <!-- Latest Check-in -->
        <div class="field">
          <label for="beginOut" class="block text-sm font-medium mb-2">
            Latest Check-in
          </label>
          <input 
            id="beginOut" 
            type="time" 
            pInputText 
            class="w-full"
            formControlName="beginOut"
          />
        </div>

        <!-- Earliest Check-out -->
        <div class="field">
          <label for="endIn" class="block text-sm font-medium mb-2">
            Earliest Check-out
          </label>
          <input 
            id="endIn" 
            type="time" 
            pInputText 
            class="w-full"
            formControlName="endIn"
          />
        </div>

        <!-- Latest Check-out -->
        <div class="field">
          <label for="endOut" class="block text-sm font-medium mb-2">
            Latest Check-out
          </label>
          <input 
            id="endOut" 
            type="time" 
            pInputText 
            class="w-full"
            formControlName="endOut"
          />
        </div>
      </div>
    </div>

    <!-- Form Actions -->
    <div class="flex justify-end gap-3 mt-6 pt-4 border-t">
      <button 
        pButton 
        [label]="'common.buttons.cancel' | translate" 
        class="p-button-secondary" 
        type="button"
        (click)="onCancel()">
      </button>
      <button 
        pButton 
        [label]="(isEditMode ? 'common.buttons.update' : 'common.buttons.add') | translate" 
        [loading]="loading"
        [disabled]="timeTableForm.invalid"
        type="submit">
      </button>
    </div>
  </form>
</p-dialog>
<p-toast></p-toast>
