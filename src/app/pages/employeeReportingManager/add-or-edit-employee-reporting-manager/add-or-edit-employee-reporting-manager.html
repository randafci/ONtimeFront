<div class="card">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0 w-full">{{ 'employeesReporting.listPage.title' | translate }}</h2>
    <div class="flex gap-2">
      <!-- Apply Button (only shown when selection is not empty) -->
      <button *ngIf="selectedEmployees?.length" pButton [label]="'employeesReporting.listPage.applyButton' | translate"
        icon="pi pi-check" class="p-button-success p-button-sm h-fit" (click)="openApplyPopup()"></button>

      <!-- Create Button -->
      <button pButton [label]="'employeesReporting.listPage.createButton' | translate" icon="pi pi-plus"
        class="p-button-sm h-fit" (click)="navigateToAdd()"></button>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section mb-6 p-6 bg-gray-50 rounded-lg shadow-sm">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">
      {{ 'employeesReporting.listPage.filters.title' | translate }}
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Company -->
      <div class="field">
        <label for="company" class="block text-sm font-medium mb-2 text-gray-700">
          {{ 'employeesReporting.listPage.filters.company' | translate }}
        </label>
        <p-select id="company" [options]="companies" optionLabel="name" optionValue="id" [(ngModel)]="selectedCompanyId"
          (onChange)="filterEmployees()" [showClear]="true"
          placeholder="{{ 'employeesReporting.listPage.filters.selectCompany' | translate }}" class="w-full">
        </p-select>
      </div>

      <!-- Department -->
      <div class="field">
        <label for="department" class="block text-sm font-medium mb-2 text-gray-700">
          {{ 'employeesReporting.listPage.filters.department' | translate }}
        </label>
        <p-select id="department" [options]="departments" optionLabel="name" optionValue="id"
          [(ngModel)]="selectedDepartmentId" (onChange)="filterEmployees()" [showClear]="true"
          placeholder="{{ 'employeesReporting.listPage.filters.selectDepartment' | translate }}" class="w-full">
        </p-select>
      </div>

      <!-- Reporting Managers -->
      <div class="field">
        <label for="reportingManagers" class="block text-sm font-medium mb-2 text-gray-700">
          {{ 'employeesReporting.listPage.filters.reportingManagers' | translate }}
        </label>
        <p-select id="reportingManagers" [options]="reportingManagers" optionLabel="name" optionValue="id"
          [(ngModel)]="selectedReportingManagerId" (onChange)="filterEmployees()" [showClear]="true"
          placeholder="{{ 'employeesReporting.listPage.filters.selectReportingManagers' | translate }}" class="w-full">
        </p-select>
      </div>
    </div>
  </div>

  <!-- Enhanced Table -->
  <p-table #employeeTable [value]="employees" [(selection)]="selectedEmployees" dataKey="id" [rowHover]="true"
    [showGridlines]="true" [paginator]="true" [rows]="10"
    [globalFilterFields]="['employeeCode', 'employeeName', 'departmentName', 'designationName', 'reportingManagers']">

    <!-- Search Template -->
    <ng-template pTemplate="caption">
      <div class="flex justify-between items-center flex-column sm:flex-row">
        <button pButton [label]="'common.buttons.clear' | translate" class="p-button-outlined mb-2" icon="pi pi-filter-slash"
          (click)="clearTable(employeeTable)"></button>
        <p-iconfield iconPosition="left" class="ml-auto">
          <p-inputicon>
            <i class="pi pi-search"></i>
          </p-inputicon>
          <input pInputText type="text" (input)="onGlobalFilter(employeeTable, $event)"
            [placeholder]="'common.searchPlaceholder' | translate" />
        </p-iconfield>
      </div>
    </ng-template>

    <!-- Header with Filters -->
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th style="min-width: 10rem">
          <div class="flex justify-between items-center">
            {{ 'employeesReporting.listPage.headers.employeeId' | translate }}
            <p-columnFilter type="text" field="employeeCode" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          <div class="flex justify-between items-center">
            {{ 'employeesReporting.listPage.headers.employeeName' | translate }}
            <p-columnFilter type="text" field="employeeName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          <div class="flex justify-between items-center">
            {{ 'employeesReporting.listPage.headers.department' | translate }}
            <p-columnFilter type="text" field="departmentName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 12rem">
          <div class="flex justify-between items-center">
            {{ 'employeesReporting.listPage.headers.designation' | translate }}
            <p-columnFilter type="text" field="designationName" display="menu"></p-columnFilter>
          </div>
        </th>
        <th style="min-width: 14rem">
          <div class="flex justify-between items-center">
            {{ 'employeesReporting.listPage.headers.reportingManagers' | translate }}
            <p-columnFilter type="text" field="reportingManagers" display="menu"></p-columnFilter>
          </div>
        </th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-emp>
      <tr [pSelectableRow]="emp">
        <td>
          <p-tableCheckbox [value]="emp"></p-tableCheckbox>
        </td>
        <td>{{ emp.employeeCode }}</td>
        <td>{{ emp.employeeName }}</td>
        <td>{{ emp.departmentName || 'N/A' }}</td>
        <td>{{ emp.designationName || 'N/A' }}</td>
        <td>{{ getManagersDisplay(emp) }}</td>
      </tr>
    </ng-template>

    <!-- Empty Message -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="6" class="text-center">
          {{ 'common.emptyMessage' | translate }}
        </td>
      </tr>
    </ng-template>

    <!-- Loading Template -->
    <ng-template pTemplate="loadingbody">
      <tr>
        <td [attr.colspan]="6" class="text-center">
          {{ 'common.loading' | translate }}
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>


<!-- Apply Popup -->
<p-dialog [header]="'employeesReporting.listPage.applyDialog.title' | translate" [(visible)]="applyDialogVisible"
  [modal]="true" [style]="{ width: '40vw'}">

  <ng-template #header>
    <div class="inline-flex items-center justify-center gap-2">
      <span class="font-bold whitespace-nowrap">{{ 'employeesReporting.listPage.applyDialog.title' | translate }}</span>
    </div>
  </ng-template>

  <div class="p-fluid" style="min-height: 45vh; display: flex; flex-direction: column; justify-content: center;">
    <div class="field mb-4">
      <label>{{ 'employeesReporting.listPage.applyDialog.selectEmployee' | translate }}</label>
      <p-select [options]="employeesList" optionLabel="employeeName" optionValue="id"
        [(ngModel)]="selectedReportMangerEmployeeId" [filter]="true"
        [filterPlaceholder]="'common.searchPlaceholder' | translate"
        [placeholder]="'employeesReporting.listPage.applyDialog.selectEmployeePlaceholder' | translate"
        class="w-full">
      </p-select>
    </div>

    <div class="field mb-4">
      <label>{{ 'employeesReporting.listPage.applyDialog.level' | translate }}</label>
      <input type="number" class="w-full" pInputText [(ngModel)]="level" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button pButton [label]="'common.buttons.cancel' | translate" icon="pi pi-times"
      (click)="applyDialogVisible=false"></button>
    <button pButton [label]="'common.buttons.apply' | translate" icon="pi pi-check" class="p-button-success"
      (click)="applyAction()"></button>
  </ng-template>
</p-dialog>



<!-- Conflict Resolution Popup -->
<p-dialog [header]="'employeesReporting.conflictDialog.title' | translate" [(visible)]="conflictDialogVisible"
  [modal]="true" [style]="{ width: '40vw' }">

  <div class="mb-4">
    <p>{{ 'employeesReporting.conflictDialog.message' | translate }}</p>
    <ul class="list-disc ml-6">
      <li *ngFor="let emp of conflictEmployees">
        <strong>{{ emp.employeeName }}</strong> â†’
        {{ emp.conflictingManagers.join(', ') }}
      </li>
    </ul>
  </div>

  <ng-template pTemplate="footer">
    <button pButton [label]="'employeesReporting.conflictDialog.buttons.ignore' | translate" class="p-button-secondary"
      (click)="sendUpdate(ManagerConflictResolution.Ignore)"></button>
    <button pButton [label]="'employeesReporting.conflictDialog.buttons.continue' | translate" class="p-button-secondary"
      (click)="sendUpdate(ManagerConflictResolution.Continue)"></button>
    <button pButton [label]="'employeesReporting.conflictDialog.buttons.replace' | translate" class="p-button-warning"
      (click)="sendUpdate(ManagerConflictResolution.Replace)"></button>
    <button pButton [label]="'employeesReporting.conflictDialog.buttons.levelUp' | translate" class="p-button-info"
      (click)="sendUpdate(ManagerConflictResolution.LevelUp)"></button>
    <button pButton [label]="'employeesReporting.conflictDialog.buttons.levelDown' | translate" class="p-button-help"
      (click)="sendUpdate(ManagerConflictResolution.LevelDown)"></button>
  </ng-template>
</p-dialog>



<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>